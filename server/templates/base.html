<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Yelp Image Captioning</title>
    <link href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet"> 
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <script src="{{ url_for('static', filename='js/plotly-latest.min.js') }}"></script>   
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Yelp Dataset Challenge: Image Captioning System</a>

            <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bd-description-modal-lg">
                How does this work?
            </button>
            <a class="btn btn-primary" href ="https://github.com/tamirbennatan/Yelp-Image-Captioning", target="_blank">
                <i class="fab fa-github-square"></i>
                See the code!
            </a>
        </div>
    </nav>
    <div class="container">
        <div id="content" style="margin-top:2em">{% block content %}{% endblock %}</div>
    </div>
</body>

<!-- 'How does this work?' Modal content -->
<div class="modal fade bd-description-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      WHEEEES
    </div>
  </div>
</div>

<footer>
    <script src="{{ url_for('static', filename='js/main.js') }}" type="text/javascript"></script> 
    <script>

    $(document).ready(function () {
    // Init
    $('.image-section').hide();
    $(".sample-img-preview").hide();
    $('.loader').hide();
    $('#result').hide();

    // Upload Preview
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                $('#imagePreview').hide();
                $('#imagePreview').fadeIn(650);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    $("#imageUpload").change(function () {
        $('.sample-img-preview').hide();
        $('#sample-image-section').hide();
        $('.img-preview').show();
        $('.image-section').show();
        $('#btn-predict').show();
        readURL(this);
    });

        // Predict
    $('#btn-predict').click(function () {
        var form_data = new FormData($('#upload-file')[0]);

        // Show loading animation
        $(this).hide();
        $('.loader').show();

        // Make prediction by calling api /predict
        $.ajax({
            type: 'POST',
            url: '/predict',
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            async: true,
            success: function (data) {
                // Get and display the result
                $('.loader').hide();
                // Make a plot
                var plotData = JSON.parse(JSON.stringify(data));
                // set up axes and ticks
                var layout = {
                title: 'Top Caption Predictions for Image',
                  yaxis: {
                    title: "Caption",
                    autorange: true,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                  },
                  xaxis: {
                    title:"Caption Score"
                  }
                }

                Plotly.newPlot('chartDiv', plotData, layout);
            },
        });
    });

    $(".sample-image").click(function(){

        // Hide all modals
        $(".modal").modal('hide');
        //show the sample image section
        $('#sample-image-section').show();
        // hide the uploaded image section
        $('.image-section').hide();
        $('.img-preview').hide();
        // hide previous sample images
        $('.sample-img-preview').hide();
         // get the source of the image that was elected
        var selected_image_src = $(this).attr("src");
        // show the images that have this source
        $('div[id="' + selected_image_src + '"]').show();
        // show the loader
        $('.loader').show();

        // store the source of the image to show
        var src = $(this).attr('src');

        // Make prediction by calling api /sample_predict
        $.ajax({
            type: 'POST',
            url: '/sample_image',
            data: src,
            contentType: false,
            cache: false,
            processData: false,
            async: true,
            success: function (data) {
                // Get and display the result
                $('.loader').hide();
                // Make a plot
                var plotData = JSON.parse(JSON.stringify(data));
                // set up axes and ticks
                var layout = {
                title: 'Top Caption Predictions for Image',
                  yaxis: {
                    title: "Caption",
                    autorange: true,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                  },
                  xaxis: {
                    title:"Caption Score"
                  }
                }

                Plotly.newPlot('chartDiv', plotData, layout);
            },
        });

    });
});

    
    </script>
</footer>

</html>